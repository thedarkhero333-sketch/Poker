<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Texas Hold'em Pro</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{ margin:0; background:#0e1a2b; font-family:Arial; color:white; text-align:center; }
h1{ margin:15px; }
#debug { font-size:12px; color:#ccc; margin-bottom:4px; }
#table{ width:900px; height:520px; margin:20px auto; background:radial-gradient(circle at center,#1e7d3c 0%,#115c2c 70%); border-radius:300px; position:relative; border:14px solid #5a3e1b; }
.seat{ width:160px; height:160px; background:#1c1c1c; border-radius:12px; position:absolute; padding:8px; font-size:14px; }
.turn{ border:2px solid gold; }
.role{ position:absolute; top:-12px; right:-12px; width:32px; height:32px; border-radius:50%; background:gold; color:black; font-weight:bold; display:flex; align-items:center; justify-content:center; }
.card{ display:inline-block; width:60px; height:90px; background:white; border-radius:10px; margin:4px; font-weight:bold; font-size:22px; line-height:90px; box-shadow:0 0 8px rgba(0,0,0,0.6); }
.red{ color:red; } .black{ color:black; }
.hidden{ background:linear-gradient(45deg,#444,#111); }
#community{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
#pot{ font-size:22px; margin-top:10px; }
#sidepots{ font-size:14px; margin-top:5px; color:#00ffcc; }
#winnerText{ margin-top:10px; font-size:20px; color:gold; min-height:30px; }
button{ padding:8px 15px; margin:5px; font-size:15px; cursor:pointer; border-radius:6px; border:none; }
#controls{ margin-top:20px; }
.raiseInput{ width:70px; padding:5px; }
.betAmount{ color:#00ffcc; font-size:13px; }
.allin{ color:red; font-weight:bold; }
.chip{ position:absolute; width:20px; height:20px; background:red; border-radius:50%; pointer-events:none; }
#stage{ font-size:18px; margin-top:5px; color:#00ffcc; }
</style>
</head>
<body>

<h1>♠ Texas Hold'em Pro ♣</h1>
<div id="debug">debug: connecting...</div>
<div id="stage"></div>
<div id="pot">Pozo: $0</div>
<div id="sidepots"></div>

<div id="table"><div id="community"></div></div>

<div id="winnerText"></div>
<div id="controls"></div>

<script>
const socket = io();
let myId = null;
let gameState = null;
let playersGlobal = [];
let previousBets = {};

socket.on("connect", () => {
  myId = socket.id;
  document.getElementById("debug").innerText = `myId: ${myId}`;
});

socket.on("update", data => {
  playersGlobal = data.players || [];
  gameState = data.gameState || {};

  document.getElementById("pot").innerText = "Pozo: $" + (gameState.pot || 0);
  document.getElementById("debug").innerText = `myId: ${myId}  |  turn: ${gameState.turn} (type: ${typeof gameState.turn})`;

  renderStage();
  renderSidePots();
  renderCommunity();
  renderPlayers();
  renderControls();
});

socket.on("connect_error", err => {
  document.getElementById("debug").innerText = `socket error: ${err.message}`;
});

function renderStage(){
  const stages = ["Preflop","Flop","Turn","River","Showdown"];
  document.getElementById("stage").innerText = stages[gameState.stage] || "";
}

function renderSidePots(){
  const div = document.getElementById("sidepots");
  div.innerHTML = "";
  if(!gameState.sidePots) return;
  gameState.sidePots.forEach((p,i) => { div.innerHTML += `Side Pot ${i+1}: $${p.amount}<br>`; });
}

function renderCommunity(){
  const div = document.getElementById("community");
  div.innerHTML = "";
  (gameState.community || []).forEach(c => div.appendChild(createCard(c)));
}

function createCard(text){
  const div = document.createElement("div");
  div.className = "card";
  const suit = text.slice(-1);
  const value = text.slice(0, -1);
  div.classList.add((suit==="♥"||suit==="♦") ? "red" : "black");
  div.innerText = value + suit;
  return div;
}

function renderPlayers(){
  document.querySelectorAll(".seat").forEach(e => e.remove());
  const positions = [
    {top:"5%",left:"45%"},{top:"20%",left:"80%"},{top:"65%",left:"80%"},
    {top:"80%",left:"45%"},{top:"65%",left:"5%"},{top:"20%",left:"5%"}
  ];

  playersGlobal.forEach((p,i) => {
    const seat = document.createElement("div");
    seat.className = "seat";
    seat.style.top = positions[i].top;
    seat.style.left = positions[i].left;

    if (gameState.turn === p.id) seat.classList.add("turn");

    const roleHtml = p.role ? `<div class="role">${p.role}</div>` : "";
    let cardsHtml = "";
    if (p.id === myId || gameState.reveal) {
      (p.cards || []).forEach(c => cardsHtml += cardHTML(c));
    } else if (!p.folded) {
      cardsHtml += `<div class="card hidden"></div><div class="card hidden"></div>`;
    }

    const allinHtml = p.allIn ? `<div class="allin">ALL-IN</div>` : "";

    seat.innerHTML = `${roleHtml}<b>${p.name}</b><br>$${p.money}<br><div class="betAmount">Apuesta: $${p.bet}</div>${allinHtml}${cardsHtml}`;
    document.getElementById("table").appendChild(seat);

    // animate chip only when player's bet increased since last update
    if (previousBets[p.id] !== undefined && p.bet > previousBets[p.id]) {
      animateChips(seat, p.bet - (previousBets[p.id] || 0));
    }
    previousBets[p.id] = p.bet;
  });
}

function cardHTML(c){
  const suit = c.slice(-1);
  const value = c.slice(0,-1);
  const color = (suit==="♥"||suit==="♦")?"red":"black";
  return `<div class="card ${color}">${value}${suit}</div>`;
}

function animateChips(seat, amount) {
  // place chip at seat and animate to center of table
  const chip = document.createElement("div");
  chip.className = "chip";
  document.getElementById("table").appendChild(chip);

  const table = document.getElementById("table");
  const rectSeat = seat.getBoundingClientRect();
  const rectTable = table.getBoundingClientRect();

  const startX = rectSeat.left - rectTable.left + rectSeat.width / 2 - 10; // center of seat minus half chip
  const startY = rectSeat.top - rectTable.top + rectSeat.height / 2 - 10;

  chip.style.left = startX + "px";
  chip.style.top = startY + "px";

  const endX = rectTable.width / 2 - 10;
  const endY = rectTable.height / 2 - 10;

  chip.animate([
    { transform: "translate(0,0)", opacity:1 },
    { transform: `translate(${endX - startX}px,${endY - startY}px)`, opacity:1 }
  ], { duration: 700, easing: "ease-out" });

  setTimeout(()=>chip.remove(), 750);
}

/* ---------- Controls ---------- */
function renderControls() {
  const div = document.getElementById("controls");
  div.innerHTML = "";

  const me = playersGlobal.find(p => p.id === myId);
  if (!me) return;

  // Show debug win/turn info
  if (gameState && gameState.turn) {
    // ensure client knows it's their turn
  }

  // Only show controls if it's your turn and not all-in
  if (gameState.turn !== myId) return;
  if (me.allIn) return;

  const toCall = (gameState.currentBet || 0) - (me.bet || 0);

  if (toCall > 0) {
    const call = document.createElement("button");
    call.innerText = "Call $" + toCall;
    call.onclick = () => socket.emit("call");
    div.appendChild(call);

    // Also show "All-in" quick button (calls all remaining)
    const allInBtn = document.createElement("button");
    allInBtn.innerText = "All-in";
    allInBtn.onclick = () => {
      // compute remaining stack and emit as raise to push total into pot
      const remaining = me.money;
      if (remaining > 0) socket.emit("raise", remaining);
    };
    div.appendChild(allInBtn);
  } else {
    const check = document.createElement("button");
    check.innerText = "Check";
    check.onclick = () => socket.emit("check");
    div.appendChild(check);
  }

  // Raise input
  const raiseInput = document.createElement("input");
  raiseInput.type = "number";
  raiseInput.min = "1";
  raiseInput.max = me.money;
  raiseInput.className = "raiseInput";
  raiseInput.placeholder = "Raise";

  const raiseBtn = document.createElement("button");
  raiseBtn.innerText = "Raise";
  raiseBtn.onclick = () => {
    const val = parseInt(raiseInput.value);
    if (val > 0 && val <= me.money) socket.emit("raise", val);
  };

  const fold = document.createElement("button");
  fold.innerText = "Fold";
  fold.onclick = () => socket.emit("fold");

  div.appendChild(raiseInput);
  div.appendChild(raiseBtn);
  div.appendChild(fold);
}
</script>
</body>
</html>
