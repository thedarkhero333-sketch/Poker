<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Poker Online</title>
<script src="/socket.io/socket.io.js"></script>

<style>

body{
  margin:0;
  background:#0e1a2b;
  font-family:Arial;
  color:white;
  text-align:center;
}

h1{ margin:15px; }

#table{
  width:850px;
  height:500px;
  margin:20px auto;
  background:radial-gradient(circle at center,#1e7d3c 0%,#115c2c 70%);
  border-radius:250px;
  position:relative;
  border:12px solid #5a3e1b;
}

.seat{
  width:150px;
  height:140px;
  background:#1c1c1c;
  border-radius:12px;
  position:absolute;
  padding:5px;
  font-size:14px;
}

.turn{
  border:2px solid gold;
}

.role{
  position:absolute;
  top:-10px;
  right:-10px;
  width:30px;
  height:30px;
  border-radius:50%;
  background:gold;
  color:black;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
}

.card{
  display:inline-block;
  width:55px;
  height:80px;
  background:white;
  border-radius:8px;
  margin:3px;
  font-weight:bold;
  font-size:20px;
  line-height:80px;
}

.red{ color:red; }
.black{ color:black; }

.hidden{
  background:#222;
}

#community{
  position:absolute;
  top:45%;
  left:50%;
  transform:translate(-50%,-50%);
}

#pot{
  font-size:22px;
  margin-top:10px;
}

#winnerText{
  margin-top:10px;
  font-size:20px;
  color:gold;
  min-height:30px;
}

button{
  padding:8px 15px;
  margin:5px;
  font-size:15px;
  cursor:pointer;
  border-radius:6px;
  border:none;
}

#controls{
  margin-top:20px;
}

.betAmount{
  color:#00ffcc;
  font-size:13px;
}

</style>
</head>
<body>

<h1>♠ Texas Hold'em ♣</h1>

<div id="pot">Pozo: $0</div>

<div id="table">
  <div id="community"></div>
</div>

<div id="winnerText"></div>

<div id="controls"></div>

<script>

const socket = io();
let myId=null;
let currentTurn=null;
let revealCards=false;
let currentBet=0;
let playersGlobal=[];

socket.on("connect",()=>{
  myId=socket.id;
});

socket.on("update",data=>{

  playersGlobal=data.players;
  currentTurn=data.gameState.turn;
  revealCards=data.gameState.reveal;
  currentBet=data.gameState.currentBet;

  document.getElementById("pot").innerText=
    "Pozo: $"+data.gameState.pot;

  renderCommunity(data.gameState.community);
  renderPlayers(data.players);
  renderControls();
});

socket.on("showdown",data=>{
  document.getElementById("winnerText").innerText=
    "Ganador: "+getPlayerName(data.winner)+" con "+data.description;
});

function getPlayerName(id){
  const p=playersGlobal.find(x=>x.id===id);
  return p? p.name:"";
}

function renderCommunity(cards){
  const div=document.getElementById("community");
  div.innerHTML="";
  cards.forEach(c=>{
    div.appendChild(createCard(c));
  });
}

function createCard(text){
  const div=document.createElement("div");
  div.className="card";

  const suit=text.slice(-1);
  const value=text.slice(0,-1);

  if(suit==="♥"||suit==="♦")
    div.classList.add("red");
  else
    div.classList.add("black");

  div.innerText=value+suit;
  return div;
}

function renderPlayers(players){

  document.querySelectorAll(".seat").forEach(e=>e.remove());

  const positions=[
    {top:"5%",left:"45%"},
    {top:"20%",left:"80%"},
    {top:"65%",left:"80%"},
    {top:"80%",left:"45%"},
    {top:"65%",left:"5%"},
    {top:"20%",left:"5%"}
  ];

  players.forEach((p,index)=>{

    const seat=document.createElement("div");
    seat.className="seat";
    seat.style.top=positions[index].top;
    seat.style.left=positions[index].left;

    if(p.id===currentTurn)
      seat.classList.add("turn");

    let cardsHtml="";

    if(p.id===myId || revealCards){
      p.cards.forEach(c=>{
        cardsHtml+=createCardHTML(c);
      });
    }else if(!p.folded){
      cardsHtml+=
        `<div class="card hidden"></div>
         <div class="card hidden"></div>`;
    }

    let roleHtml="";
    if(p.role){
      roleHtml=`<div class="role">${p.role}</div>`;
    }

    seat.innerHTML=
      `${roleHtml}
       <div><b>${p.name}</b></div>
       <div>$${p.money}</div>
       <div class="betAmount">Apuesta: $${p.bet||0}</div>
       ${cardsHtml}`;

    document.getElementById("table").appendChild(seat);
  });
}

function createCardHTML(c){
  const suit=c.slice(-1);
  const value=c.slice(0,-1);
  const color=(suit==="♥"||suit==="♦")?"red":"black";
  return `<div class="card ${color}">${value}${suit}</div>`;
}

/* =========================
   CONTROLES DINÁMICOS
========================= */

function renderControls(){

  const div=document.getElementById("controls");
  div.innerHTML="";

  const me=playersGlobal.find(p=>p.id===myId);
  if(!me) return;

  if(currentTurn!==myId) return;

  const toCall=currentBet - (me.bet||0);

  // CALL
  if(toCall>0){
    const callBtn=document.createElement("button");
    callBtn.innerText="Call $"+toCall;
    callBtn.onclick=()=>socket.emit("bet",toCall);
    div.appendChild(callBtn);
  }

  // CHECK (solo si no hay que igualar)
  if(toCall===0){
    const checkBtn=document.createElement("button");
    checkBtn.innerText="Check";
    checkBtn.onclick=()=>socket.emit("bet",0);
    div.appendChild(checkBtn);
  }

  // FOLD
  const foldBtn=document.createElement("button");
  foldBtn.innerText="Fold";
  foldBtn.onclick=()=>socket.emit("fold");
  div.appendChild(foldBtn);
}

</script>

</body>
</html>
